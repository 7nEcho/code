# å·¥å…·è°ƒç”¨æ¶æ„å®Œæ•´è¯´æ˜æ–‡æ¡£

> æœ¬æ–‡æ¡£é¢å‘å¸Œæœ›æ·±å…¥ç†è§£ piteAgents å·¥å…·è°ƒç”¨æœºåˆ¶çš„å¼€å‘è€…ï¼Œè¯¦ç»†è¯´æ˜å·¥å…·ç®¡ç†ã€Agent å·¥å…·å…³è”ã€å·¥å…·è°ƒç”¨æµç¨‹ä»¥åŠå½“å‰å®ç°çŠ¶æ€ã€‚

---

## ç›®å½•

1. [å·¥å…·è°ƒç”¨æ¦‚è¿°](#1-å·¥å…·è°ƒç”¨æ¦‚è¿°)
2. [æ•°æ®åº“è®¾è®¡](#2-æ•°æ®åº“è®¾è®¡)
3. [Agent è·å–å·¥å…·åˆ—è¡¨](#3-agent-è·å–å·¥å…·åˆ—è¡¨)
4. [å·¥å…·å±æ€§è¯¦è§£](#4-å·¥å…·å±æ€§è¯¦è§£)
5. [å·¥å…·è°ƒç”¨æµç¨‹](#5-å·¥å…·è°ƒç”¨æµç¨‹)
6. [å½“å‰å®ç°çŠ¶æ€](#6-å½“å‰å®ç°çŠ¶æ€)
7. [å®Œæ•´å®ç°æ–¹æ¡ˆ](#7-å®Œæ•´å®ç°æ–¹æ¡ˆ)

---

## 1. å·¥å…·è°ƒç”¨æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯å·¥å…·è°ƒç”¨ï¼Ÿ

å·¥å…·è°ƒç”¨ï¼ˆTool Calling / Function Callingï¼‰æ˜¯å¤§æ¨¡å‹çš„ä¸€é¡¹æ ¸å¿ƒèƒ½åŠ›ï¼Œå…è®¸ AI åœ¨å¯¹è¯è¿‡ç¨‹ä¸­**ä¸»åŠ¨è°ƒç”¨å¤–éƒ¨å·¥å…·æˆ– API** æ¥è·å–å®æ—¶ä¿¡æ¯ã€æ‰§è¡Œç‰¹å®šæ“ä½œï¼Œä»è€Œç”Ÿæˆæ›´å‡†ç¡®ã€æ›´æœ‰ä»·å€¼çš„å›ç­”ã€‚

**å…¸å‹åœºæ™¯ï¼š**
- ğŸ” **æœç´¢å·¥å…·**ï¼šæŸ¥è¯¢æœ€æ–°æ–°é—»ã€å¤©æ°”ã€è‚¡ç¥¨ä»·æ ¼
- ğŸ’» **ä»£ç æ‰§è¡Œ**ï¼šè¿è¡Œä»£ç ç‰‡æ®µå¹¶è¿”å›ç»“æœ
- ğŸ“Š **æ•°æ®æŸ¥è¯¢**ï¼šä»æ•°æ®åº“æˆ– API è·å–å®æ—¶æ•°æ®
- ğŸ› ï¸ **ä¸šåŠ¡æ“ä½œ**ï¼šåˆ›å»ºè®¢å•ã€å‘é€é‚®ä»¶ã€é¢„çº¦æœåŠ¡

### 1.2 ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        User[ç”¨æˆ·]
    end
    
    subgraph "åº”ç”¨å±‚"
        Controller[ChatController]
        AgentCtrl[AgentController]
    end
    
    subgraph "ä¸šåŠ¡å±‚"
        ZhipuService[ZhipuService<br/>å·¥å…·è°ƒç”¨åè°ƒ]
        ToolService[ToolService<br/>å·¥å…·ç®¡ç†]
        ToolExecutor[ToolExecutor<br/>å·¥å…·æ‰§è¡Œå™¨]
    end
    
    subgraph "æ•°æ®å±‚"
        DB[(MySQL)]
        ToolDef[tool_definition<br/>å·¥å…·å®šä¹‰]
        AgentTool[agent_tool<br/>Agentå·¥å…·å…³è”]
    end
    
    subgraph "å¤–éƒ¨æœåŠ¡"
        AI[æ™ºè°±AI]
        ExternalAPI[å¤–éƒ¨å·¥å…·API]
    end
    
    User --> Controller
    User --> AgentCtrl
    Controller --> ZhipuService
    AgentCtrl --> ToolService
    ToolService --> DB
    ZhipuService --> AI
    ZhipuService --> ToolService
    ZhipuService --> ToolExecutor
    ToolExecutor --> ExternalAPI
    ToolService --> ToolDef
    ToolService --> AgentTool
    
    style ZhipuService fill:#e1f5ff
    style ToolService fill:#fff4e1
    style ToolExecutor fill:#ffe1e1
```

---

## 2. æ•°æ®åº“è®¾è®¡

### 2.1 ER å…³ç³»å›¾

```mermaid
erDiagram
    AGENT ||--o{ AGENT_TOOL : "æ‹¥æœ‰"
    TOOL_DEFINITION ||--o{ AGENT_TOOL : "è¢«ä½¿ç”¨"
    AGENT ||--|| AGENT_CONFIG : "é…ç½®"
    
    AGENT {
        bigint id PK
        string name "Agentåç§°"
        string category "åˆ†ç±»"
        text system_prompt "ç³»ç»Ÿæç¤ºè¯"
        boolean is_active "æ˜¯å¦å¯ç”¨"
    }
    
    TOOL_DEFINITION {
        bigint id PK
        string name "å·¥å…·åç§°(å”¯ä¸€)"
        text description "å·¥å…·æè¿°"
        string endpoint "HTTPç«¯ç‚¹"
        string method "HTTPæ–¹æ³•"
        text parameters "å‚æ•°å®šä¹‰(JSON Schema)"
        text headers "è¯·æ±‚å¤´(JSON)"
        int timeout "è¶…æ—¶æ—¶é—´ms"
        int retry_count "é‡è¯•æ¬¡æ•°"
        boolean is_active "æ˜¯å¦å¯ç”¨"
    }
    
    AGENT_TOOL {
        bigint agent_id FK
        bigint tool_id FK
        int sort_order "è°ƒç”¨ä¼˜å…ˆçº§"
        text tool_config "ä¸ªæ€§åŒ–é…ç½®"
        boolean is_enabled "æ˜¯å¦å¯ç”¨"
    }
    
    AGENT_CONFIG {
        bigint agent_id FK
        string model "ä½¿ç”¨çš„æ¨¡å‹"
        decimal temperature "æ¸©åº¦å‚æ•°"
        int max_tokens "æœ€å¤§Token"
    }
```

### 2.2 è¡¨ç»“æ„è¯´æ˜

#### tool_definitionï¼ˆå·¥å…·å®šä¹‰è¡¨ï¼‰

å­˜å‚¨å¯è°ƒç”¨å·¥å…·çš„å…ƒæ•°æ®ï¼Œå®šä¹‰äº†å·¥å…·çš„åŸºæœ¬ä¿¡æ¯å’Œè°ƒç”¨è§„èŒƒã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `id` | BIGINT | ä¸»é”®ID | 1 |
| `name` | VARCHAR(100) | å·¥å…·å”¯ä¸€åç§° | `"web_search"` |
| `description` | TEXT | å·¥å…·åŠŸèƒ½æè¿° | `"æœç´¢äº’è”ç½‘ä¸Šçš„ç›¸å…³ä¿¡æ¯"` |
| `endpoint` | VARCHAR(500) | HTTP API åœ°å€ | `"https://api.search.com/query"` |
| `method` | VARCHAR(10) | HTTP æ–¹æ³• | `"POST"` |
| `parameters` | TEXT | JSON Schema å‚æ•°å®šä¹‰ | `{"type":"object",...}` |
| `headers` | TEXT | HTTP è¯·æ±‚å¤´ï¼ˆJSONï¼‰ | `{"Authorization":"Bearer xxx"}` |
| `timeout` | INT | è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | `30000` |
| `retry_count` | INT | å¤±è´¥é‡è¯•æ¬¡æ•° | `3` |
| `is_active` | BOOLEAN | æ˜¯å¦å¯ç”¨ | `TRUE` |

#### agent_toolï¼ˆAgent å·¥å…·å…³è”è¡¨ï¼‰

ç®¡ç†æ¯ä¸ª Agent å¯ä»¥ä½¿ç”¨å“ªäº›å·¥å…·ï¼Œä»¥åŠè°ƒç”¨çš„ä¼˜å…ˆçº§å’Œä¸ªæ€§åŒ–é…ç½®ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `agent_id` | BIGINT | Agent IDï¼ˆè”åˆä¸»é”®ï¼‰ | 1 |
| `tool_id` | BIGINT | å·¥å…·IDï¼ˆè”åˆä¸»é”®ï¼‰ | 5 |
| `sort_order` | INT | è°ƒç”¨ä¼˜å…ˆçº§ï¼ˆè¶Šå°è¶Šä¼˜å…ˆï¼‰ | 0 |
| `tool_config` | TEXT | ä¸ªæ€§åŒ–é…ç½®ï¼ˆJSONï¼‰ | `{"max_results": 10}` |
| `is_enabled` | BOOLEAN | æ˜¯å¦å¯ç”¨ | `TRUE` |

---

## 3. Agent è·å–å·¥å…·åˆ—è¡¨

### 3.1 API æ¥å£

**è·å– Agent çš„å·¥å…·åˆ—è¡¨ï¼š**

```http
GET /api/agents/{agentId}/tools
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "toolId": 1,
      "name": "web_search",
      "description": "æœç´¢äº’è”ç½‘ä¸Šçš„ç›¸å…³ä¿¡æ¯",
      "endpoint": "https://api.search.com/query",
      "method": "POST",
      "parameters": {
        "type": "object",
        "properties": {
          "query": {
            "type": "string",
            "description": "æœç´¢å…³é”®è¯"
          }
        },
        "required": ["query"]
      },
      "headers": null,
      "sortOrder": 0,
      "enabled": true
    }
  ]
}
```

### 3.2 å®ç°æµç¨‹

```mermaid
sequenceDiagram
    autonumber
    participant Client as å‰ç«¯/å®¢æˆ·ç«¯
    participant Controller as AgentController
    participant Service as ToolService
    participant Mapper as ToolDefinitionMapper
    participant DB as MySQLæ•°æ®åº“
    
    Client->>Controller: GET /api/agents/1/tools
    Controller->>Service: listAgentTools(agentId=1)
    Service->>Mapper: selectList(agent_id=1)
    Mapper->>DB: SELECT FROM agent_tool<br/>WHERE agent_id=1
    DB-->>Mapper: è¿”å›å…³è”è®°å½•åˆ—è¡¨
    Mapper-->>Service: List<AgentToolPO>
    Service->>Mapper: selectBatchIds(toolIds)
    Mapper->>DB: SELECT FROM tool_definition<br/>WHERE id IN (...)
    DB-->>Mapper: è¿”å›å·¥å…·å®šä¹‰åˆ—è¡¨
    Mapper-->>Service: List<ToolDefinitionPO>
    Service->>Service: åˆå¹¶å…³è”ä¿¡æ¯å’Œå·¥å…·å®šä¹‰
    Service-->>Controller: List<AgentToolDTO>
    Controller-->>Client: ApiResponseåŒ…è£…åçš„å·¥å…·åˆ—è¡¨
```

### 3.3 ä»£ç å®ç°

**æ§åˆ¶å™¨å±‚** (`AgentController.java:171`)

```java
@GetMapping("/{agentId}/tools")
public ApiResponse<List<AgentToolDTO>> listAgentTools(@PathVariable Long agentId) {
    log.info("æŸ¥è¯¢ Agent å·¥å…·åˆ—è¡¨ï¼ŒagentId: {}", agentId);
    List<AgentToolDTO> tools = toolService.listAgentTools(agentId);
    return ApiResponse.success(tools);
}
```

**æœåŠ¡å±‚** (`ToolServiceImpl.java:262`)

```java
@Override
@Transactional(readOnly = true)
public List<AgentToolDTO> listAgentTools(Long agentId) {
    // 1. æŸ¥è¯¢ Agent-å·¥å…·å…³è”å…³ç³»
    List<AgentToolPO> relations = agentToolMapper.selectList(
        Wrappers.<AgentToolPO>lambdaQuery()
            .eq(AgentToolPO::getAgentId, agentId)
            .orderByAsc(AgentToolPO::getSortOrder)  // æŒ‰ä¼˜å…ˆçº§æ’åº
    );
    
    // 2. æ‰¹é‡æŸ¥è¯¢å·¥å…·å®šä¹‰
    Set<Long> toolIds = relations.stream()
        .map(AgentToolPO::getToolId)
        .collect(Collectors.toSet());
    List<ToolDefinitionPO> tools = toolDefinitionMapper.selectBatchIds(toolIds);
    
    // 3. åˆå¹¶å…³è”ä¿¡æ¯å’Œå·¥å…·å®šä¹‰
    return relations.stream()
        .map(relation -> {
            ToolDefinitionPO tool = toolMap.get(relation.getToolId());
            return AgentToolDTO.builder()
                .toolId(tool.getId())
                .name(tool.getName())
                .description(tool.getDescription())
                .endpoint(tool.getEndpoint())
                .method(tool.getMethod())
                .parameters(fromJsonToObjectMap(tool.getParameters()))
                .sortOrder(relation.getSortOrder())  // æ¥è‡ªå…³è”è¡¨
                .enabled(relation.getIsEnabled())    // æ¥è‡ªå…³è”è¡¨
                .build();
        })
        .collect(Collectors.toList());
}
```

**Mapper å±‚** (`ToolDefinitionMapper.xml:36`)

```xml
<select id="selectToolsByAgentId" resultMap="BaseResultMap">
    SELECT t.*
    FROM tool_definition t
    INNER JOIN agent_tool at ON t.id = at.tool_id
    WHERE at.agent_id = #{agentId}
      AND at.is_enabled = TRUE
      AND t.is_active = TRUE
    ORDER BY at.sort_order ASC
</select>
```

### 3.4 å½“å‰æ”¯æŒçš„åŠŸèƒ½

âœ… **å·²å®ç°ï¼š**
- å·¥å…·çš„ CRUD ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ï¼‰
- Agent ä¸å·¥å…·çš„å…³è”ï¼ˆç»‘å®šã€è§£ç»‘ã€æŸ¥è¯¢ï¼‰
- å·¥å…·åˆ—è¡¨æŒ‰ä¼˜å…ˆçº§æ’åº
- å·¥å…·å¯ç”¨/ç¦ç”¨æ§åˆ¶
- ä¸ªæ€§åŒ–å·¥å…·é…ç½®

âŒ **æœªå®ç°ï¼š**
- Agent å¯¹è¯æ—¶è‡ªåŠ¨åŠ è½½å…¶å·¥å…·åˆ—è¡¨
- åŠ¨æ€å·¥å…·æ‰§è¡Œå™¨ï¼ˆè°ƒç”¨çœŸå® HTTP endpointï¼‰
- å·¥å…·è°ƒç”¨æ—¥å¿—è®°å½•
- å·¥å…·è°ƒç”¨å¤±è´¥çš„é‡è¯•æœºåˆ¶
- å¤šå·¥å…·å¹¶å‘è°ƒç”¨

---

## 4. å·¥å…·å±æ€§è¯¦è§£

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›å±æ€§ï¼Ÿ

å·¥å…·å®šä¹‰åŒ…å«äº†å®Œæ•´çš„ HTTP API è°ƒç”¨æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ¯ä¸ªå±æ€§éƒ½æœ‰å…¶ç‰¹å®šç”¨é€”ï¼š

```mermaid
graph LR
    A[å·¥å…·å®šä¹‰] --> B[AIç†è§£å±‚]
    A --> C[HTTPè°ƒç”¨å±‚]
    A --> D[å¯é æ€§æ§åˆ¶å±‚]
    
    B --> B1[name: AIè¯†åˆ«å·¥å…·]
    B --> B2[description: AIç†è§£ç”¨é€”]
    B --> B3[parameters: AIæ„é€ å‚æ•°]
    
    C --> C1[endpoint: è°ƒç”¨åœ°å€]
    C --> C2[method: HTTPæ–¹æ³•]
    C --> C3[headers: è®¤è¯ä¿¡æ¯]
    
    D --> D1[timeout: è¶…æ—¶æ§åˆ¶]
    D --> D2[retryCount: é‡è¯•æœºåˆ¶]
    D --> D3[isActive: å¼€å…³æ§åˆ¶]
    
    style B fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#e8f5e9
```

### 4.2 å±æ€§è¯¦ç»†è¯´æ˜

#### 4.2.1 AI ç†è§£å±‚å±æ€§

è¿™äº›å±æ€§ç”¨äºè®© AI ç†è§£å’Œæ™ºèƒ½é€‰æ‹©å·¥å…·ã€‚

| å±æ€§ | ç±»å‹ | å¿…å¡« | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|------|------|
| **name** | String | âœ… | å·¥å…·å”¯ä¸€æ ‡è¯†ç¬¦ï¼ŒAI é€šè¿‡æ­¤åç§°è¯†åˆ«å·¥å…· | `"web_search"`, `"code_executor"` |
| **description** | String | âœ… | å·¥å…·åŠŸèƒ½æè¿°ï¼Œ**å¸®åŠ© AI ç†è§£ä½•æ—¶è°ƒç”¨æ­¤å·¥å…·** | `"å½“ç”¨æˆ·éœ€è¦æŸ¥è¯¢æœ€æ–°ä¿¡æ¯æ—¶ï¼Œä½¿ç”¨æ­¤å·¥å…·æœç´¢äº’è”ç½‘"` |
| **parameters** | JSON Schema | âš ï¸ | å®šä¹‰å·¥å…·è¾“å…¥å‚æ•°çš„ç»“æ„ï¼Œ**AI æ ¹æ®æ­¤å®šä¹‰æ„é€ è°ƒç”¨å‚æ•°** | è§ä¸‹æ–¹è¯¦è§£ |

**parameters ç¤ºä¾‹ï¼š**

```json
{
  "type": "object",
  "properties": {
    "query": {
      "type": "string",
      "description": "æœç´¢å…³é”®è¯"
    },
    "limit": {
      "type": "integer",
      "description": "è¿”å›ç»“æœæ•°é‡",
      "default": 10
    }
  },
  "required": ["query"]
}
```

**AI å¦‚ä½•ä½¿ç”¨ parametersï¼Ÿ**

1. AI è¯»å– `properties` äº†è§£éœ€è¦å“ªäº›å‚æ•°
2. AI æ ¹æ®ç”¨æˆ·é—®é¢˜æå–ç›¸å…³ä¿¡æ¯
3. AI æ„é€ ç¬¦åˆ schema çš„å‚æ•° JSON
4. ç³»ç»Ÿæ”¶åˆ° AI çš„è°ƒç”¨è¯·æ±‚åï¼Œä½¿ç”¨è¿™äº›å‚æ•°è°ƒç”¨å®é™… API

#### 4.2.2 HTTP è°ƒç”¨å±‚å±æ€§

è¿™äº›å±æ€§ç”¨äºå®é™…æ‰§è¡Œ HTTP è¯·æ±‚ã€‚

| å±æ€§ | ç±»å‹ | å¿…å¡« | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|------|------|
| **endpoint** | String | âœ… | å·¥å…·çš„ HTTP API åœ°å€ | `"https://api.weather.com/v1/query"` |
| **method** | String | âœ… | HTTP è¯·æ±‚æ–¹æ³• | `"POST"`, `"GET"`, `"PUT"` |
| **headers** | JSON | âš ï¸ | HTTP è¯·æ±‚å¤´ï¼Œå¦‚è®¤è¯ä¿¡æ¯ã€Content-Type | `{"Authorization": "Bearer xxx"}` |

**headers ä½¿ç”¨åœºæ™¯ï¼š**

```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer sk-xxx",
  "X-Custom-Header": "custom-value"
}
```

#### 4.2.3 å¯é æ€§æ§åˆ¶å±‚å±æ€§

è¿™äº›å±æ€§ç”¨äºæé«˜å·¥å…·è°ƒç”¨çš„å¯é æ€§å’Œå¯æ§æ€§ã€‚

| å±æ€§ | ç±»å‹ | é»˜è®¤å€¼ | ä½œç”¨ | å»ºè®®å€¼ |
|------|------|--------|------|--------|
| **timeout** | Integer | 30000 | è°ƒç”¨è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé˜²æ­¢é•¿æ—¶é—´ç­‰å¾… | 10000-60000 |
| **retryCount** | Integer | 3 | å¤±è´¥åçš„é‡è¯•æ¬¡æ•°ï¼Œæé«˜æˆåŠŸç‡ | 1-5 |
| **isActive** | Boolean | true | å…¨å±€å¯ç”¨å¼€å…³ï¼Œå¿«é€Ÿç¦ç”¨é—®é¢˜å·¥å…· | true/false |

**ä¸ºä»€ä¹ˆéœ€è¦ timeoutï¼Ÿ**

```java
// åœºæ™¯ï¼šå¤–éƒ¨APIå“åº”æ…¢æˆ–ç½‘ç»œæ•…éšœ
try {
    HttpResponse response = httpClient.execute(request, timeout);
} catch (TimeoutException e) {
    // è¶…æ—¶åå¯ä»¥é‡è¯•æˆ–è¿”å›é”™è¯¯ï¼Œé¿å…ç”¨æˆ·é•¿æ—¶é—´ç­‰å¾…
}
```

**ä¸ºä»€ä¹ˆéœ€è¦ retryCountï¼Ÿ**

```java
// åœºæ™¯ï¼šç½‘ç»œæŠ–åŠ¨æˆ–ä¸´æ—¶æ•…éšœ
int attempts = 0;
while (attempts < retryCount) {
    try {
        return callExternalAPI();
    } catch (IOException e) {
        attempts++;
        if (attempts >= retryCount) throw e;
        Thread.sleep(1000 * attempts); // æŒ‡æ•°é€€é¿
    }
}
```

### 4.3 å±æ€§å¿…è¦æ€§æ€»ç»“

| å±æ€§ | å¿…è¦æ€§ | ç†ç”± |
|------|--------|------|
| name | â­â­â­â­â­ | å·¥å…·å”¯ä¸€æ ‡è¯†ï¼Œç¼ºå°‘æ— æ³•è¯†åˆ« |
| description | â­â­â­â­â­ | AI æ™ºèƒ½é€‰æ‹©çš„å…³é”®ï¼Œç¼ºå°‘ä¼šå¯¼è‡´è¯¯è°ƒç”¨ |
| endpoint | â­â­â­â­â­ | å®é™…è°ƒç”¨åœ°å€ï¼Œç¼ºå°‘æ— æ³•æ‰§è¡Œ |
| method | â­â­â­â­â­ | HTTP æ–¹æ³•å¿…éœ€ |
| parameters | â­â­â­â­ | æœ‰å‚æ•°çš„å·¥å…·å¿…éœ€ï¼Œæ— å‚å·¥å…·å¯çœç•¥ |
| headers | â­â­â­ | éœ€è¦è®¤è¯çš„ API å¿…éœ€ |
| timeout | â­â­â­ | é˜²æ­¢è¶…æ—¶ï¼Œå»ºè®®ä¿ç•™ |
| retryCount | â­â­ | æé«˜å¯é æ€§ï¼Œå¯é€‰ |
| isActive | â­â­â­ | è¿ç»´æ§åˆ¶å¼€å…³ï¼Œå»ºè®®ä¿ç•™ |

**ç»“è®ºï¼š** è¿™äº›å±æ€§éƒ½æœ‰å®é™…ç”¨é€”ï¼Œä¸æ˜¯å†—ä½™è®¾è®¡ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå®Œæ•´çš„HTTPå·¥å…·è°ƒç”¨éœ€è¦è¿™äº›é…ç½®æ¥ä¿è¯åŠŸèƒ½å®Œæ•´æ€§å’Œå¯é æ€§ã€‚

---

## 5. å·¥å…·è°ƒç”¨æµç¨‹

### 5.1 å®Œæ•´è°ƒç”¨æµç¨‹å›¾

```mermaid
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant Controller as ChatController
    participant Service as ZhipuService
    participant ToolSvc as ToolService
    participant Executor as ToolExecutor
    participant AI as æ™ºè°±AI
    participant API as å¤–éƒ¨å·¥å…·API
    participant DB as æ•°æ®åº“
    
    User->>Controller: POST /api/chat<br/>{agentId, messages}
    
    Note over Controller,Service: ç¬¬ä¸€é˜¶æ®µï¼šåŠ è½½å·¥å…·å®šä¹‰
    Controller->>Service: chatWithAgent(agentId, messages)
    Service->>ToolSvc: getAgentTools(agentId)
    ToolSvc->>DB: æŸ¥è¯¢agent_toolå’Œtool_definition
    DB-->>ToolSvc: è¿”å›å·¥å…·åˆ—è¡¨
    ToolSvc-->>Service: List<ToolDefinitionPO>
    Service->>Service: è½¬æ¢ä¸ºChatToolåˆ—è¡¨
    
    Note over Service,AI: ç¬¬äºŒé˜¶æ®µï¼šAIåˆ¤æ–­æ˜¯å¦éœ€è¦å·¥å…·
    Service->>AI: è°ƒç”¨AIï¼ˆé™„å¸¦å·¥å…·åˆ—è¡¨ï¼‰
    AI->>AI: åˆ†æç”¨æˆ·é—®é¢˜
    AI-->>Service: è¿”å›tool_callsæˆ–ç›´æ¥å›ç­”
    
    alt AIè¿”å›tool_calls
        Note over Service,API: ç¬¬ä¸‰é˜¶æ®µï¼šæ‰§è¡Œå·¥å…·
        loop éå†æ¯ä¸ªtool_call
            Service->>Executor: execute(toolName, arguments)
            Executor->>Executor: è§£æå‚æ•°
            Executor->>API: HTTPè¯·æ±‚<br/>(endpoint, method, params)
            API-->>Executor: è¿”å›ç»“æœ
            Executor-->>Service: å·¥å…·æ‰§è¡Œç»“æœ
        end
        
        Note over Service,AI: ç¬¬å››é˜¶æ®µï¼šAIç”Ÿæˆæœ€ç»ˆå›ç­”
        Service->>Service: æ„å»ºå®Œæ•´ä¸Šä¸‹æ–‡<br/>(åŸæ¶ˆæ¯+toolè°ƒç”¨+toolç»“æœ)
        Service->>AI: ç¬¬äºŒæ¬¡è°ƒç”¨AI
        AI-->>Service: åŸºäºå·¥å…·ç»“æœçš„æœ€ç»ˆå›ç­”
    else AIç›´æ¥å›ç­”
        Service-->>Controller: ç›´æ¥è¿”å›AIå›ç­”
    end
    
    Service-->>Controller: ChatResponse
    Controller-->>User: è¿”å›æœ€ç»ˆç»“æœ
```

### 5.2 å…³é”®ä»£ç ç¤ºä¾‹

#### æ­¥éª¤1ï¼šä»æ•°æ®åº“åŠ è½½ Agent çš„å·¥å…·åˆ—è¡¨

```java
// å½“å‰ï¼šç¡¬ç¼–ç ï¼ˆPOCé˜¶æ®µï¼‰
ChatTool helloPoxTool = ChatTool.builder()
    .type("function")
    .function(ChatFunction.builder()
        .name("hello_pox")
        .description("è¿”å›é—®å€™è¯­")
        .parameters(ChatFunctionParameters.builder().type("object").build())
        .build())
    .build();

// æœªæ¥ï¼šä»æ•°æ®åº“åŠ¨æ€åŠ è½½
List<ToolDefinitionPO> toolDefs = toolMapper.selectToolsByAgentId(agentId);
List<ChatTool> tools = toolDefs.stream()
    .map(this::convertToChatTool)
    .collect(Collectors.toList());
```

#### æ­¥éª¤2ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨ AIï¼Œé™„å¸¦å·¥å…·åˆ—è¡¨

```java
ChatCompletionCreateParams request = ChatCompletionCreateParams.builder()
    .model("glm-4.5")
    .messages(messages)
    .tools(tools)  // å…³é”®ï¼šæŠŠå·¥å…·åˆ—è¡¨ä¼ ç»™AI
    .build();

ChatCompletionResponse response = zhipuAiClient.chat().createChatCompletion(request);
```

#### æ­¥éª¤3ï¼šæ£€æŸ¥ AI æ˜¯å¦è¿”å› tool_calls

```java
var message = response.getData().getChoices().get(0).getMessage();
var toolCalls = message.getToolCalls();

if (toolCalls != null && !toolCalls.isEmpty()) {
    // AI å†³å®šè°ƒç”¨å·¥å…·
    for (var toolCall : toolCalls) {
        String toolName = toolCall.getFunction().getName();
        String arguments = toolCall.getFunction().getArguments();
        String toolCallId = toolCall.getId();
        
        // æ‰§è¡Œå·¥å…·...
    }
}
```

#### æ­¥éª¤4ï¼šæ‰§è¡Œå·¥å…·å¹¶è·å–ç»“æœ

```java
// å½“å‰ï¼šç¡¬ç¼–ç å·¥å…·å®ç°
if ("hello_pox".equals(toolName)) {
    toolResult = helloPoxToolService.execute();
}

// æœªæ¥ï¼šé€šç”¨HTTPå·¥å…·æ‰§è¡Œå™¨
ToolDefinitionPO toolDef = toolMapper.selectByName(toolName);
String result = toolExecutor.execute(
    toolDef.getEndpoint(),
    toolDef.getMethod(),
    arguments,  // AIç”Ÿæˆçš„å‚æ•°JSON
    toolDef.getHeaders(),
    toolDef.getTimeout()
);
```

#### æ­¥éª¤5ï¼šæ„å»ºåŒ…å«å·¥å…·ç»“æœçš„ä¸Šä¸‹æ–‡

```java
List<ChatMessage> messagesWithToolResult = new ArrayList<>();
messagesWithToolResult.addAll(originalMessages);  // åŸå§‹å¯¹è¯
messagesWithToolResult.add(message);  // AIçš„tool_callè¯·æ±‚

// æ·»åŠ å·¥å…·æ‰§è¡Œç»“æœ
ChatMessage toolResultMessage = ChatMessage.builder()
    .role("tool")
    .content(toolResult)
    .toolCallId(toolCallId)  // å¿…é¡»åŒ¹é…AIçš„è°ƒç”¨ID
    .build();
messagesWithToolResult.add(toolResultMessage);
```

#### æ­¥éª¤6ï¼šç¬¬äºŒæ¬¡è°ƒç”¨ AI ç”Ÿæˆæœ€ç»ˆå›ç­”

```java
ChatCompletionCreateParams request2 = ChatCompletionCreateParams.builder()
    .model("glm-4.5")
    .messages(messagesWithToolResult)  // åŒ…å«å·¥å…·ç»“æœçš„å®Œæ•´ä¸Šä¸‹æ–‡
    .build();

ChatCompletionResponse finalResponse = zhipuAiClient.chat().createChatCompletion(request2);
```

---

## 6. å½“å‰å®ç°çŠ¶æ€

### 6.1 å·²å®ç°åŠŸèƒ½ âœ…

#### å·¥å…·ç®¡ç†æ¨¡å—

| åŠŸèƒ½ | API | çŠ¶æ€ | æ–‡ä»¶ |
|------|-----|------|------|
| åˆ›å»ºå·¥å…· | `POST /api/tools` | âœ… | ToolController.java:33 |
| æŸ¥è¯¢å·¥å…·åˆ—è¡¨ | `GET /api/tools` | âœ… | ToolController.java:76 |
| æŸ¥è¯¢å·¥å…·è¯¦æƒ… | `GET /api/tools/{id}` | âœ… | ToolController.java:93 |
| æ›´æ–°å·¥å…· | `PUT /api/tools/{id}` | âœ… | ToolController.java:47 |
| åˆ é™¤å·¥å…· | `DELETE /api/tools/{id}` | âœ… | ToolController.java:61 |

#### Agent å·¥å…·å…³è”

| åŠŸèƒ½ | API | çŠ¶æ€ | æ–‡ä»¶ |
|------|-----|------|------|
| ç»‘å®šå·¥å…·åˆ° Agent | `POST /api/agents/{agentId}/tools` | âœ… | AgentController.java:157 |
| æŸ¥è¯¢ Agent çš„å·¥å…· | `GET /api/agents/{agentId}/tools` | âœ… | AgentController.java:171 |

#### åŸºç¡€å·¥å…·è°ƒç”¨

| åŠŸèƒ½ | API | çŠ¶æ€ | æ–‡ä»¶ |
|------|-----|------|------|
| å·¥å…·è°ƒç”¨æµ‹è¯•æ¥å£ | `POST /api/chat/with-tools` | âœ… | ChatController.java:134 |
| HelloPox ç¤ºä¾‹å·¥å…· | - | âœ… | HelloPoxToolService.java |

### 6.2 æœªå®ç°åŠŸèƒ½ âŒ

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Agent å¯¹è¯æ—¶åŠ¨æ€åŠ è½½å·¥å…· | âŒ | å½“å‰å·¥å…·ç¡¬ç¼–ç ï¼Œæœªé›†æˆåˆ° Agent å¯¹è¯æµç¨‹ |
| HTTP å·¥å…·æ‰§è¡Œå™¨ | âŒ | ç¼ºå°‘é€šç”¨çš„ HTTP å®¢æˆ·ç«¯è°ƒç”¨é€»è¾‘ |
| å·¥å…·å‚æ•°éªŒè¯ | âŒ | æœªéªŒè¯ AI ç”Ÿæˆçš„å‚æ•°æ˜¯å¦ç¬¦åˆ JSON Schema |
| å·¥å…·è°ƒç”¨æ—¥å¿— | âŒ | æœªè®°å½•å·¥å…·è°ƒç”¨çš„è¯¦ç»†æ—¥å¿— |
| å·¥å…·è°ƒç”¨é‡è¯•æœºåˆ¶ | âŒ | æœªå®ç°å¤±è´¥é‡è¯•é€»è¾‘ |
| å¤šå·¥å…·å¹¶å‘è°ƒç”¨ | âŒ | å½“å‰åªå¤„ç†ç¬¬ä¸€ä¸ª tool_call |
| å·¥å…·è°ƒç”¨è¶…æ—¶æ§åˆ¶ | âŒ | æœªä½¿ç”¨ timeout å±æ€§ |
| å·¥å…·é‰´æƒ | âŒ | æœªä½¿ç”¨ headers ä¸­çš„è®¤è¯ä¿¡æ¯ |

### 6.3 å½“å‰æµç¨‹ vs å®Œæ•´æµç¨‹å¯¹æ¯”

```mermaid
graph TB
    subgraph "å½“å‰å®ç°ï¼ˆPOCé˜¶æ®µï¼‰"
        A1[ç”¨æˆ·è¯·æ±‚] --> B1[ç¡¬ç¼–ç hello_poxå·¥å…·]
        B1 --> C1[AIåˆ¤æ–­]
        C1 --> D1{éœ€è¦å·¥å…·?}
        D1 -->|æ˜¯| E1[è°ƒç”¨HelloPoxToolService]
        D1 -->|å¦| F1[ç›´æ¥è¿”å›]
        E1 --> G1[è¿”å›å›ºå®šå­—ç¬¦ä¸²]
        G1 --> H1[AIç”Ÿæˆæœ€ç»ˆå›ç­”]
    end
    
    subgraph "å®Œæ•´å®ç°ï¼ˆç”Ÿäº§ç›®æ ‡ï¼‰"
        A2[ç”¨æˆ·è¯·æ±‚+AgentID] --> B2[ä»æ•°æ®åº“åŠ è½½Agentå·¥å…·åˆ—è¡¨]
        B2 --> C2[è½¬æ¢ä¸ºChatToolåˆ—è¡¨]
        C2 --> D2[AIåˆ¤æ–­]
        D2 --> E2{éœ€è¦å·¥å…·?}
        E2 -->|æ˜¯| F2[è§£æå·¥å…·åç§°å’Œå‚æ•°]
        F2 --> G2[ToolExecutoræ‰§è¡ŒHTTPè°ƒç”¨]
        G2 --> H2[å¤„ç†å“åº”/é‡è¯•/è¶…æ—¶]
        E2 -->|å¦| I2[ç›´æ¥è¿”å›]
        H2 --> J2[AIç”Ÿæˆæœ€ç»ˆå›ç­”]
    end
    
    style A1 fill:#ffe1e1
    style A2 fill:#e1ffe1
```

---

## 7. å®Œæ•´å®ç°æ–¹æ¡ˆ

### 7.1 ç¼ºå¤±ç»„ä»¶ï¼šToolExecutorï¼ˆå·¥å…·æ‰§è¡Œå™¨ï¼‰

å·¥å…·æ‰§è¡Œå™¨è´Ÿè´£æ ¹æ®å·¥å…·å®šä¹‰è°ƒç”¨å®é™…çš„ HTTP APIã€‚

**å®ç°ä½ç½®ï¼š** `service/ToolExecutor.java`ï¼ˆå¾…åˆ›å»ºï¼‰

**æ ¸å¿ƒèŒè´£ï¼š**
1. æ ¹æ®å·¥å…·å®šä¹‰æ„å»º HTTP è¯·æ±‚
2. æ‰§è¡Œ HTTP è°ƒç”¨
3. å¤„ç†è¶…æ—¶å’Œé‡è¯•
4. è§£æå“åº”å¹¶è¿”å›ç»“æœ
5. è®°å½•è°ƒç”¨æ—¥å¿—

**ä¼ªä»£ç ï¼š**

```java
@Service
public class ToolExecutor {
    
    public String execute(ToolDefinitionPO tool, String argumentsJson) {
        // 1. è§£æå‚æ•°
        Map<String, Object> params = parseArguments(argumentsJson);
        
        // 2. æ„å»ºHTTPè¯·æ±‚
        HttpRequest request = buildHttpRequest(
            tool.getEndpoint(),
            tool.getMethod(),
            params,
            parseHeaders(tool.getHeaders())
        );
        
        // 3. æ‰§è¡Œè¯·æ±‚ï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•ï¼‰
        int attempts = 0;
        while (attempts < tool.getRetryCount()) {
            try {
                HttpResponse response = httpClient.execute(
                    request, 
                    tool.getTimeout()
                );
                return response.body();
            } catch (Exception e) {
                attempts++;
                if (attempts >= tool.getRetryCount()) {
                    throw new ToolExecutionException("å·¥å…·è°ƒç”¨å¤±è´¥", e);
                }
                Thread.sleep(calculateBackoff(attempts));
            }
        }
    }
}
```

### 7.2 é›†æˆåˆ° Agent å¯¹è¯æµç¨‹

**éœ€è¦ä¿®æ”¹çš„æ–¹æ³•ï¼š** `ZhipuServiceImpl.chatWithTools()`

**æ”¹é€ æ–¹æ¡ˆï¼š**

```java
@Override
public ChatResponse chatWithTools(ChatRequest request, Long agentId) {
    // 1. ä»æ•°æ®åº“åŠ è½½ Agent çš„å·¥å…·åˆ—è¡¨ï¼ˆæ›¿æ¢ç¡¬ç¼–ç ï¼‰
    List<ToolDefinitionPO> toolDefs = toolMapper.selectToolsByAgentId(agentId);
    List<ChatTool> tools = toolDefs.stream()
        .map(this::convertToChatTool)
        .collect(Collectors.toList());
    
    // 2. æ„å»ºè¯·æ±‚å¹¶è°ƒç”¨ AI
    ChatCompletionCreateParams requestWithTools = buildChatRequestWithTools(request, tools);
    ChatCompletionResponse response1 = zhipuAiClient.chat().createChatCompletion(requestWithTools);
    
    // 3. æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
    var toolCalls = response1.getData().getChoices().get(0).getMessage().getToolCalls();
    
    if (toolCalls != null && !toolCalls.isEmpty()) {
        // 4. æ‰§è¡Œæ‰€æœ‰å·¥å…·è°ƒç”¨ï¼ˆæ”¯æŒå¤šå·¥å…·ï¼‰
        List<ChatMessage> toolResults = new ArrayList<>();
        for (var toolCall : toolCalls) {
            String toolName = toolCall.getFunction().getName();
            String arguments = toolCall.getFunction().getArguments();
            
            // æŸ¥æ‰¾å·¥å…·å®šä¹‰
            ToolDefinitionPO toolDef = toolDefs.stream()
                .filter(t -> t.getName().equals(toolName))
                .findFirst()
                .orElseThrow(() -> new Exception("æœªçŸ¥å·¥å…·: " + toolName));
            
            // ä½¿ç”¨ ToolExecutor æ‰§è¡Œå·¥å…·
            String result = toolExecutor.execute(toolDef, arguments);
            
            // æ„å»ºå·¥å…·ç»“æœæ¶ˆæ¯
            toolResults.add(ChatMessage.builder()
                .role("tool")
                .content(result)
                .toolCallId(toolCall.getId())
                .build());
        }
        
        // 5. ç¬¬äºŒæ¬¡è°ƒç”¨ AIï¼ŒåŸºäºå·¥å…·ç»“æœç”Ÿæˆå›ç­”
        // ...
    }
    
    return convertResponse(response2);
}
```

### 7.3 æ•°æ®æµå›¾

```mermaid
graph LR
    A[ç”¨æˆ·é—®é¢˜] --> B[ChatController]
    B --> C{æŒ‡å®šAgentID?}
    C -->|æ˜¯| D[æŸ¥è¯¢Agentå·¥å…·åˆ—è¡¨]
    C -->|å¦| E[ä½¿ç”¨ç©ºå·¥å…·åˆ—è¡¨]
    D --> F[ä»DBåŠ è½½tool_definition]
    F --> G[è½¬æ¢ä¸ºChatToolæ ¼å¼]
    E --> G
    G --> H[è°ƒç”¨æ™ºè°±AI<br/>é™„å¸¦å·¥å…·åˆ—è¡¨]
    H --> I{AIè¿”å›tool_calls?}
    I -->|å¦| J[ç›´æ¥è¿”å›AIå›ç­”]
    I -->|æ˜¯| K[è§£æå·¥å…·åç§°å’Œå‚æ•°]
    K --> L[æŸ¥æ‰¾å·¥å…·å®šä¹‰]
    L --> M[ToolExecutoræ‰§è¡Œ]
    M --> N[æ„å»ºHTTPè¯·æ±‚]
    N --> O[è°ƒç”¨å¤–éƒ¨API]
    O --> P[å¤„ç†å“åº”]
    P --> Q[ç¬¬äºŒæ¬¡è°ƒç”¨AI]
    Q --> R[è¿”å›æœ€ç»ˆå›ç­”]
    
    style D fill:#e1f5ff
    style M fill:#fff4e1
    style O fill:#ffe1e1
```

---

## 8. å·¥å…·å®šä¹‰ç¤ºä¾‹

### 8.1 æœç´¢å·¥å…·ç¤ºä¾‹

```json
{
  "name": "web_search",
  "description": "å½“ç”¨æˆ·éœ€è¦æŸ¥è¯¢æœ€æ–°ä¿¡æ¯ã€å®æ—¶æ•°æ®æˆ–äº’è”ç½‘ä¸Šçš„å†…å®¹æ—¶ï¼Œä½¿ç”¨æ­¤å·¥å…·æœç´¢ã€‚ä¾‹å¦‚ï¼šæœ€æ–°æ–°é—»ã€å¤©æ°”ã€è‚¡ç¥¨ä»·æ ¼ç­‰ã€‚",
  "endpoint": "https://api.search.com/v1/query",
  "method": "POST",
  "parameters": {
    "type": "object",
    "properties": {
      "query": {
        "type": "string",
        "description": "æœç´¢å…³é”®è¯"
      },
      "limit": {
        "type": "integer",
        "description": "è¿”å›ç»“æœæ•°é‡",
        "default": 5,
        "minimum": 1,
        "maximum": 10
      }
    },
    "required": ["query"]
  },
  "headers": {
    "Authorization": "Bearer sk-xxx",
    "Content-Type": "application/json"
  },
  "timeout": 10000,
  "retryCount": 2,
  "isActive": true
}
```

### 8.2 ä»£ç æ‰§è¡Œå·¥å…·ç¤ºä¾‹

```json
{
  "name": "code_executor",
  "description": "æ‰§è¡Œ Python ä»£ç å¹¶è¿”å›ç»“æœã€‚é€‚ç”¨äºéœ€è¦è®¡ç®—ã€æ•°æ®å¤„ç†æˆ–ç®—æ³•æ¼”ç¤ºçš„åœºæ™¯ã€‚",
  "endpoint": "https://api.coderun.com/v1/execute",
  "method": "POST",
  "parameters": {
    "type": "object",
    "properties": {
      "code": {
        "type": "string",
        "description": "è¦æ‰§è¡Œçš„ Python ä»£ç "
      },
      "timeout": {
        "type": "integer",
        "description": "æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰",
        "default": 5,
        "maximum": 30
      }
    },
    "required": ["code"]
  },
  "headers": {
    "X-API-Key": "your-api-key"
  },
  "timeout": 35000,
  "retryCount": 1,
  "isActive": true
}
```

### 8.3 å¤©æ°”æŸ¥è¯¢å·¥å…·ç¤ºä¾‹

```json
{
  "name": "weather_query",
  "description": "æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å®æ—¶å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€æ¹¿åº¦ã€å¤©æ°”çŠ¶å†µç­‰ã€‚",
  "endpoint": "https://api.weather.com/v1/current",
  "method": "GET",
  "parameters": {
    "type": "object",
    "properties": {
      "city": {
        "type": "string",
        "description": "åŸå¸‚åç§°ï¼Œå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³"
      },
      "unit": {
        "type": "string",
        "description": "æ¸©åº¦å•ä½",
        "enum": ["celsius", "fahrenheit"],
        "default": "celsius"
      }
    },
    "required": ["city"]
  },
  "headers": {
    "X-Weather-API-Key": "your-weather-api-key"
  },
  "timeout": 5000,
  "retryCount": 3,
  "isActive": true
}
```

---

## 9. AI å¦‚ä½•å†³å®šè°ƒç”¨å·¥å…·ï¼Ÿ

### 9.1 å†³ç­–è¿‡ç¨‹

```mermaid
flowchart TD
    A[AIæ”¶åˆ°ç”¨æˆ·é—®é¢˜å’Œå·¥å…·åˆ—è¡¨] --> B{åˆ†æé—®é¢˜ç±»å‹}
    B -->|é™æ€çŸ¥è¯†é—®é¢˜| C[æ— éœ€å·¥å…·ï¼Œç›´æ¥å›ç­”]
    B -->|éœ€è¦å®æ—¶ä¿¡æ¯| D[æ£€æŸ¥å¯ç”¨å·¥å…·]
    B -->|éœ€è¦æ‰§è¡Œæ“ä½œ| D
    
    D --> E{æœ‰åŒ¹é…çš„å·¥å…·?}
    E -->|å¦| F[è¯´æ˜æ— æ³•å®Œæˆå¹¶è§£é‡ŠåŸå› ]
    E -->|æ˜¯| G[é€‰æ‹©æœ€åˆé€‚çš„å·¥å…·]
    
    G --> H[åˆ†æå·¥å…·çš„description]
    H --> I[æ£€æŸ¥å·¥å…·çš„parameters]
    I --> J{èƒ½æ„é€ å‚æ•°?}
    J -->|å¦| F
    J -->|æ˜¯| K[ç”Ÿæˆtool_calls]
    
    K --> L[è¿”å›tool_callsç»™ç³»ç»Ÿ]
    C --> M[è¿”å›æ–‡æœ¬å›ç­”]
    F --> M
    
    style K fill:#e1ffe1
    style M fill:#ffe1e1
```

### 9.2 å†³ç­–ä¾æ®

AI ä¸»è¦æ ¹æ®ä»¥ä¸‹ä¿¡æ¯å†³å®šæ˜¯å¦è°ƒç”¨å·¥å…·ï¼š

1. **å·¥å…·æè¿° (description)** - 80% æƒé‡
   - æè¿°è¶Šè¯¦ç»†ï¼ŒAI åŒ¹é…è¶Šå‡†ç¡®
   - åº”åŒ…å«ï¼šåŠŸèƒ½è¯´æ˜ã€é€‚ç”¨åœºæ™¯ã€å…¸å‹ç”¨ä¾‹

2. **å·¥å…·å‚æ•° (parameters)** - 15% æƒé‡
   - AI æ£€æŸ¥æ˜¯å¦èƒ½ä»ç”¨æˆ·é—®é¢˜ä¸­æå–å‚æ•°
   - å¿…éœ€å‚æ•°ç¼ºå¤±æ—¶å¯èƒ½ä¸è°ƒç”¨

3. **ç”¨æˆ·é—®é¢˜è¯­ä¹‰** - 5% æƒé‡
   - æ˜¾å¼è¦æ±‚ï¼ˆ"è¯·æœç´¢..."ï¼‰
   - éšå¼éœ€æ±‚ï¼ˆ"æœ€æ–°çš„è‚¡ç¥¨ä»·æ ¼"ï¼‰

### 9.3 ä¼˜åŒ–å·¥å…·æè¿°çš„æŠ€å·§

**âŒ ä¸å¥½çš„æè¿°ï¼š**
```json
{
  "name": "search",
  "description": "æœç´¢å·¥å…·"
}
```

**âœ… å¥½çš„æè¿°ï¼š**
```json
{
  "name": "web_search",
  "description": "å½“ç”¨æˆ·è¯¢é—®éœ€è¦å®æ—¶ä¿¡æ¯ã€æœ€æ–°æ•°æ®æˆ–äº’è”ç½‘ä¸Šçš„å†…å®¹æ—¶ä½¿ç”¨æ­¤å·¥å…·ã€‚é€‚ç”¨åœºæ™¯åŒ…æ‹¬ï¼š1) æœ€æ–°æ–°é—»å’Œäº‹ä»¶ 2) å®æ—¶å¤©æ°”å’Œè‚¡ä»· 3) ç½‘é¡µå†…å®¹æŸ¥è¯¢ 4) ä¸åœ¨æ¨¡å‹è®­ç»ƒæ•°æ®ä¸­çš„ä¿¡æ¯ã€‚è¯·ä½¿ç”¨ç®€æ´æ˜ç¡®çš„æœç´¢å…³é”®è¯ã€‚"
}
```

---

## 10. å®Œæ•´å®ç° Checklist

### 10.1 æ ¸å¿ƒç»„ä»¶

- [x] å·¥å…·å®šä¹‰è¡¨ `tool_definition`
- [x] Agent å·¥å…·å…³è”è¡¨ `agent_tool`
- [x] å·¥å…·ç®¡ç† Service (`ToolServiceImpl`)
- [x] å·¥å…·ç®¡ç† Controller (`ToolController`)
- [x] Agent å·¥å…·å…³è” API
- [x] åŸºç¡€å·¥å…·è°ƒç”¨æµç¨‹ (`chatWithTools`)
- [ ] HTTP å·¥å…·æ‰§è¡Œå™¨ (`ToolExecutor`)
- [ ] å·¥å…·å‚æ•°éªŒè¯å™¨ (`ToolParameterValidator`)
- [ ] å·¥å…·è°ƒç”¨æ—¥å¿—è¡¨ `tool_call_log`

### 10.2 Agent å¯¹è¯é›†æˆ

- [ ] ä¿®æ”¹ `ChatController`ï¼Œæ”¯æŒ `agentId` å‚æ•°
- [ ] åœ¨ `chatWithTools` ä¸­åŠ¨æ€åŠ è½½ Agent å·¥å…·åˆ—è¡¨
- [ ] æ›¿æ¢ç¡¬ç¼–ç çš„ `hello_pox` ä¸ºæ•°æ®åº“é©±åŠ¨çš„å·¥å…·
- [ ] å®ç°å·¥å…·æ‰§è¡Œå™¨è°ƒç”¨çœŸå® HTTP endpoint
- [ ] æ”¯æŒå¤šå·¥å…·å¹¶å‘è°ƒç”¨
- [ ] è®°å½•å·¥å…·è°ƒç”¨æ—¥å¿—

### 10.3 å¯é æ€§å¢å¼º

- [ ] å®ç°å·¥å…·è°ƒç”¨è¶…æ—¶æ§åˆ¶
- [ ] å®ç°å·¥å…·è°ƒç”¨é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- [ ] å®ç°å·¥å…·è°ƒç”¨ç†”æ–­æœºåˆ¶
- [ ] å·¥å…·è°ƒç”¨ç»“æœç¼“å­˜
- [ ] å·¥å…·è°ƒç”¨ç›‘æ§å’Œå‘Šè­¦

---

## 11. å®é™…è°ƒç”¨ç¤ºä¾‹

### 11.1 ç”¨æˆ·è§†è§’

**å¯¹è¯ç¤ºä¾‹ï¼š**

```
ç”¨æˆ·ï¼šåŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ

ç³»ç»Ÿå†…éƒ¨æµç¨‹ï¼š
1. è¯†åˆ« Agent ID = 1ï¼ˆé€šç”¨åŠ©æ‰‹ï¼‰
2. åŠ è½½ Agent çš„å·¥å…·åˆ—è¡¨ -> [web_search, weather_query]
3. è°ƒç”¨ AIï¼Œé™„å¸¦å·¥å…·åˆ—è¡¨
4. AI è¿”å›ï¼štool_calls = [{"name": "weather_query", "arguments": {"city": "åŒ—äº¬"}}]
5. ToolExecutor æ‰§è¡Œï¼šGET https://api.weather.com/v1/current?city=åŒ—äº¬
6. å·¥å…·è¿”å›ï¼š{"temperature": 15, "condition": "æ™´æœ—"}
7. å†æ¬¡è°ƒç”¨ AIï¼Œä¼ å…¥å·¥å…·ç»“æœ
8. AI ç”Ÿæˆæœ€ç»ˆå›ç­”ï¼š"åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ¸©åº¦çº¦15Â°Cï¼Œé€‚åˆå¤–å‡ºæ´»åŠ¨ã€‚"

ç³»ç»Ÿè¿”å›ï¼šåŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ¸©åº¦çº¦15Â°Cï¼Œé€‚åˆå¤–å‡ºæ´»åŠ¨ã€‚
```

### 11.2 å¼€å‘è€…è§†è§’

**è°ƒç”¨æµç¨‹æ—¥å¿—ï¼š**

```
[INFO] æ”¶åˆ°å¯¹è¯è¯·æ±‚ï¼ŒagentId=1, message="åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
[INFO] åŠ è½½ Agent å·¥å…·åˆ—è¡¨...
[INFO] æŸ¥è¯¢åˆ° 2 ä¸ªå·¥å…·: [web_search, weather_query]
[INFO] è½¬æ¢å·¥å…·å®šä¹‰ä¸º ChatTool æ ¼å¼
[INFO] ç¬¬ä¸€æ¬¡è°ƒç”¨ AIï¼Œé™„å¸¦ 2 ä¸ªå·¥å…·å®šä¹‰
[INFO] AI è¿”å› 1 ä¸ª tool_call: weather_query(city=åŒ—äº¬)
[INFO] æ‰§è¡Œå·¥å…·è°ƒç”¨...
[INFO] HTTPè¯·æ±‚: GET https://api.weather.com/v1/current?city=åŒ—äº¬
[INFO] å·¥å…·æ‰§è¡ŒæˆåŠŸï¼Œè€—æ—¶: 245ms
[INFO] å·¥å…·è¿”å›ç»“æœ: {"temperature":15,"condition":"æ™´æœ—"}
[INFO] æ„å»ºåŒ…å«å·¥å…·ç»“æœçš„ä¸Šä¸‹æ–‡
[INFO] ç¬¬äºŒæ¬¡è°ƒç”¨ AIï¼Œç”Ÿæˆæœ€ç»ˆå›ç­”
[INFO] å¯¹è¯å®Œæˆï¼Œæ€»è€—æ—¶: 1.2s
```

---

## 12. è¿›é˜¶è¯é¢˜

### 12.1 å·¥å…·é“¾ï¼ˆTool Chainingï¼‰

AI å¯ä»¥è¿ç»­è°ƒç”¨å¤šä¸ªå·¥å…·ï¼š

```mermaid
sequenceDiagram
    User->>AI: "å¸®æˆ‘æŸ¥åŒ—äº¬å¤©æ°”ï¼Œå¦‚æœæ¸©åº¦ä½äº10åº¦å°±æœç´¢ä¿æš–å»ºè®®"
    AI->>System: tool_call: weather_query(city="åŒ—äº¬")
    System->>AI: result: {"temperature": 8}
    AI->>System: tool_call: web_search(query="å†¬å­£ä¿æš–å»ºè®®")
    System->>AI: result: "å»ºè®®ç©¿åšå¤–å¥—..."
    AI->>User: "åŒ—äº¬ä»Šå¤©8åº¦ï¼Œå»ºè®®ç©¿åšå¤–å¥—å’Œå›´å·¾..."
```

### 12.2 å·¥å…·ç»„åˆï¼ˆTool Compositionï¼‰

å¤šä¸ªå·¥å…·å¹¶è¡Œè°ƒç”¨ï¼š

```json
{
  "tool_calls": [
    {"name": "weather_query", "arguments": {"city": "åŒ—äº¬"}},
    {"name": "weather_query", "arguments": {"city": "ä¸Šæµ·"}},
    {"name": "weather_query", "arguments": {"city": "æ·±åœ³"}}
  ]
}
```

### 12.3 å·¥å…·è°ƒç”¨å®‰å…¨

**æ½œåœ¨é£é™©ï¼š**
1. AI æ„é€ æ¶æ„å‚æ•°ï¼ˆSQLæ³¨å…¥ã€å‘½ä»¤æ³¨å…¥ï¼‰
2. å·¥å…·è°ƒç”¨é¢‘ç‡è¿‡é«˜ï¼ˆDoSï¼‰
3. æ•æ„Ÿæ•°æ®æ³„éœ²

**é˜²æŠ¤æªæ–½ï¼š**
1. å‚æ•°ä¸¥æ ¼éªŒè¯ï¼ˆJSON Schema æ ¡éªŒï¼‰
2. å·¥å…·è°ƒç”¨é¢‘ç‡é™åˆ¶
3. å·¥å…·ç»“æœè„±æ•å¤„ç†
4. å·¥å…·è°ƒç”¨å®¡è®¡æ—¥å¿—

---

## 13. æ€»ç»“

### 13.1 å½“å‰çŠ¶æ€

**å·¥å…·ç®¡ç†ï¼š** âœ… å®Œæ•´å®ç°
- å·¥å…·çš„ CRUD
- Agent å·¥å…·å…³è”
- å·¥å…·åˆ—è¡¨æŸ¥è¯¢

**å·¥å…·è°ƒç”¨ï¼š** âš ï¸ éƒ¨åˆ†å®ç°
- åŸºç¡€è°ƒç”¨æµç¨‹ï¼ˆç¡¬ç¼–ç å·¥å…·ï¼‰
- ä¸¤é˜¶æ®µè°ƒç”¨æœºåˆ¶
- ç¼ºå°‘ HTTP æ‰§è¡Œå™¨
- æœªé›†æˆåˆ° Agent å¯¹è¯

### 13.2 å…³é”®é—®é¢˜å›ç­”

**Q1: Agent å¦‚ä½•è·å–å·¥å…·åˆ—è¡¨ï¼Ÿ**

é€šè¿‡ `GET /api/agents/{agentId}/tools` æ¥å£æŸ¥è¯¢ï¼Œåº•å±‚ä½¿ç”¨ `ToolDefinitionMapper.selectToolsByAgentId()` ä»æ•°æ®åº“åŠ è½½å·¥å…·å®šä¹‰å’Œå…³è”é…ç½®ã€‚

**Q2: å½“å‰æ˜¯å¦æ”¯æŒå·¥å…·è°ƒç”¨ï¼Ÿ**

éƒ¨åˆ†æ”¯æŒï¼š
- âœ… å·¥å…·ç®¡ç†å®Œæ•´
- âœ… åŸºç¡€è°ƒç”¨æµç¨‹ï¼ˆæµ‹è¯•æ¥å£ï¼‰
- âŒ Agent å¯¹è¯æœªé›†æˆ
- âŒ ç¼ºå°‘ HTTP æ‰§è¡Œå™¨

**Q3: å·¥å…·å±æ€§æ˜¯å¦å¿…éœ€ï¼Ÿ**

æ˜¯çš„ï¼Œæ¯ä¸ªå±æ€§éƒ½æœ‰å®é™…ç”¨é€”ï¼š
- **AI å±‚**ï¼šname, description, parametersï¼ˆè®© AI ç†è§£å’Œé€‰æ‹©å·¥å…·ï¼‰
- **è°ƒç”¨å±‚**ï¼šendpoint, method, headersï¼ˆæ‰§è¡Œ HTTP è¯·æ±‚ï¼‰
- **å¯é æ€§å±‚**ï¼štimeout, retryCount, isActiveï¼ˆä¿è¯ç¨³å®šæ€§ï¼‰

### 13.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ä¼˜å…ˆçº§ P0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ï¼š**
1. å®ç° `ToolExecutor` é€šç”¨ HTTP æ‰§è¡Œå™¨
2. ä¿®æ”¹ `chatWithTools` æ”¯æŒä»æ•°æ®åº“åŠ è½½å·¥å…·
3. é›†æˆåˆ° Agent å¯¹è¯æµç¨‹

**ä¼˜å…ˆçº§ P1ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰ï¼š**
1. å·¥å…·å‚æ•°éªŒè¯
2. å·¥å…·è°ƒç”¨æ—¥å¿—
3. é‡è¯•å’Œè¶…æ—¶æœºåˆ¶

**ä¼˜å…ˆçº§ P2ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰ï¼š**
1. å·¥å…·è°ƒç”¨ç¼“å­˜
2. å·¥å…·é“¾æ”¯æŒ
3. å·¥å…·è°ƒç”¨ç›‘æ§

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-10-25  
**ç»´æŠ¤è€…**: piteAgents Team

